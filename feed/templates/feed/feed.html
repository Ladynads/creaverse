{% extends "base.html" %}

{% block content %}
<h2>üåü CreatorVerse Feed</h2>

<!-- ‚úÖ Create Post Form (Inline) -->
{% if user.is_authenticated %}
    <form method="POST" action="{% url 'new_post' %}">
        {% csrf_token %}
        <textarea name="content" placeholder="Write something amazing..." required></textarea>
        <button type="submit">‚ûï Create Post</button>
    </form>
{% endif %}

<hr>

<!-- ‚úÖ Display Posts -->
<ul id="feed-posts">
    {% for post in posts %}
        <li>
            <strong>
                <a href="{% url 'user_profile' post.user.username %}">
                    {{ post.user.username }}
                </a>
            </strong> - {{ post.created_at|date:"F j, Y, g:i a" }}
            <p>{{ post.content }}</p>

            <!-- ‚úÖ Like Button (AJAX) -->
            <button class="like-btn" data-post-id="{{ post.id }}">
                {% if user in post.likes.all %}
                    ‚ù§Ô∏è Unlike
                {% else %}
                    ü§ç Like
                {% endif %}
            </button>
            <span id="like-count-{{ post.id }}">{{ post.likes.count }}</span> Likes

            <!-- ‚úÖ Show Comments -->
            <h4>üí¨ Comments:</h4>
            <ul id="comment-list-{{ post.id }}">
                {% for comment in post.comments.all %}
                    <li>
                        <strong>
                            <a href="{% url 'user_profile' comment.user.username %}">
                                {{ comment.user.username }}
                            </a>
                        </strong>: {{ comment.content }}
                        {% if comment.user == user or post.user == user %}
                            <form action="{% url 'delete_comment' comment.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" style="color:red;">‚ùå Delete</button>
                            </form>
                        {% endif %}
                    </li>
                {% empty %}
                    <li>No comments yet. Be the first to comment!</li>
                {% endfor %}
            </ul>

            <!-- ‚úÖ Add Comment Form (AJAX) -->
            {% if user.is_authenticated %}
                <form class="comment-form" data-post-id="{{ post.id }}">
                    {% csrf_token %}
                    <input type="text" name="content" placeholder="Write a comment..." required>
                    <button type="submit">üí¨ Comment</button>
                </form>
            {% endif %}

            <!-- ‚úÖ Delete Post Button (Only for Post Owner) -->
            {% if post.user == user %}
                <form action="{% url 'delete_post' post.id %}" method="POST" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" style="color:red;">üóëÔ∏è Delete Post</button>
                </form>
            {% endif %}
            
            <hr>
        </li>
    {% empty %}
        <p>No posts yet. Be the first to post!</p>
    {% endfor %}
</ul>

<!-- ‚úÖ JavaScript for AJAX Like & Comment System -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    // ‚úÖ Function to Refresh Feed without Reloading
    function refreshFeed() {
        fetch("{% url 'feed' %}")  // Fetch fresh posts from the backend
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");
            let newPosts = doc.querySelector("ul#feed-posts").innerHTML;  // Get updated posts list
            document.querySelector("ul#feed-posts").innerHTML = newPosts;  // Replace old posts with new ones
            attachLikeHandlers();  // Reattach event listeners
            attachCommentHandlers();
        })
        .catch(error => console.error("Error fetching feed:", error));
    }

    // ‚úÖ AJAX for Likes
    function attachLikeHandlers() {
        document.querySelectorAll(".like-btn").forEach(button => {
            button.addEventListener("click", function () {
                let postId = this.dataset.postId;
                let url = `{% url 'like_post' 999999 %}`.replace('999999', postId); // ‚úÖ Dynamic URL

                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Content-Type": "application/json"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.liked) {
                        this.innerHTML = "‚ù§Ô∏è Unlike";
                    } else {
                        this.innerHTML = "ü§ç Like";
                    }
                    document.querySelector(`#like-count-${postId}`).textContent = data.total_likes;
                    refreshFeed();  // Refresh feed after like
                })
                .catch(error => console.error("Error:", error));
            });
        });
    }

    // ‚úÖ AJAX for Comments
    function attachCommentHandlers() {
        document.querySelectorAll(".comment-form").forEach(form => {
            form.addEventListener("submit", function (event) {
                event.preventDefault();  // ‚úÖ Prevent default form submission
                let postId = this.dataset.postId;
                let url = `{% url 'add_comment' 999999 %}`.replace('999999', postId);
                let formData = new FormData(this);
                
                fetch(url, {
                    method: "POST",
                    headers: { "X-CSRFToken": getCookie("csrftoken") },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        let commentList = document.querySelector(`#comment-list-${postId}`);
                        let newComment = document.createElement("li");
                        newComment.innerHTML = `<strong><a href="/users/${data.username}">${data.username}</a></strong>: ${data.comment}`;
                        commentList.appendChild(newComment);
                        this.reset();  // ‚úÖ Clear input after submission
                        refreshFeed();  // Refresh feed after comment
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });
    }

    // ‚úÖ Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ‚úÖ Auto-refresh every 10 seconds (Optional)
    setInterval(refreshFeed, 10000);  // Refresh every 10 seconds

    attachLikeHandlers();  // Attach like event listeners on page load
    attachCommentHandlers();  // Attach comment event listeners on page load
});
</script>

{% endblock %}






